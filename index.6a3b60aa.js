function e(e,t,r,a){Object.defineProperty(e,t,{get:r,set:a,enumerable:!0,configurable:!0})}var t={};function r(e){return.000621371192*e}function a(e){return new Date(e).toISOString().slice(11,-5)}function n(e,t){return Math.round(e*t)/t}function o(e,t,r,a){var n=e+t/60+r/3600;return"S"!=a&&"W"!=a||(n*=-1),n}e(t,"state",(()=>c)),e(t,"addImage",(()=>l)),e(t,"removeImage",(()=>u)),e(t,"sortImages",(()=>m)),e(t,"setTransportMode",(()=>g)),e(t,"getExifData",(()=>p)),e(t,"prepareImageData",(()=>h)),e(t,"getRoute",(()=>f)),e(t,"getPosition",(()=>v));const i={foot:"Hike",bike:"Bike",car:"Car"},d={foot:"#0b6683",bike:"#199d3c",car:"#892509"},s="db56c0cf-613e-456d-baea-46650066da62",c={images:[],transportMode:"foot",routeData:{}};function l(e){c.images.push(e)}function u(e,t){c.images=c.images.filter((r=>r[e]!==t))}function m(e){c.images=c.images.sort(((t,r)=>e.indexOf(t.imgId)-e.indexOf(r.imgId))).map(((e,t)=>({...e,imgOrder:t})))}function g(e){c.transportMode=e}async function p(e){e.exifData=null;return await new Promise(((t,r)=>EXIF.getData(e,(function(){t({Make:EXIF.getTag(this,"Make"),DateTime:EXIF.getTag(this,"DateTime"),GPSLatitudeRef:EXIF.getTag(this,"GPSLatitudeRef"),GPSLatitude:EXIF.getTag(this,"GPSLatitude"),GPSLongitudeRef:EXIF.getTag(this,"GPSLongitudeRef"),GPSLongitude:EXIF.getTag(this,"GPSLongitude")}),r(new Error(e.name+": There was an error extracting EXIF data from this image"))}))))}function h(e,t){const{DateTime:r,GPSLatitudeRef:a,GPSLatitude:n,GPSLongitudeRef:i,GPSLongitude:d}=e;if(!a||!n)throw new Error(t+" has no location data");return{DateTime:r,latitude:o(n[0],n[1],n[2],a),longitude:o(d[0],d[1],d[2],i)}}async function f(e){try{const t=c.images.sort(((e,t)=>e.imgOrder-t.imgOrder)).map((({latitude:e,longitude:t})=>[+t,+e])),r=new URLSearchParams({key:s}).toString(),a=await fetch(`https://graphhopper.com/api/1/route?${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({profile:e,points:t,points_encoded:!1})}),n=await a.json();if(!a.ok)throw new Error(`${n.message}`);return n}catch(e){throw new Error(e)}}const v=function(){return new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t)}))};var P=new class{uploadForm=document.querySelector("#upload-form");fileInput=document.querySelector("#fileInput");transportButtons=document.querySelectorAll("input[name=transport-mode]");_clearBtn=document.querySelector("#clear-btn");_userLocationInput=document.querySelector("#user-location");imageList=document.querySelector("#image_list");dropZone=document.querySelector("#drop_zone");routePreviewCard;routePanel;locationPreviewCard;addHandlerFileInput(e){this.fileInput.addEventListener("change",(async function(t){const r=this.files;r.length&&e(r)}))}addHandlerTransportButton(e){this.transportButtons.forEach((t=>t.addEventListener("click",(function(t){e(t)}))))}addHandlerDropInput(e){["dragenter","dragover","dragleave","drop"].forEach((e=>{this.dropZone.addEventListener(e,n,!1)})),["dragenter","dragover"].forEach((e=>{this.dropZone.addEventListener(e,r,!1)})),["dragleave","drop"].forEach((e=>{this.dropZone.addEventListener(e,a,!1)})),this.dropZone.addEventListener("drop",(async function(t){let r=t.dataTransfer.files;r.length&&e(r)}),!1);const t=document.querySelector("#drop_zone small");function r(e){this.classList.add("highlight"),t.innerText="Drop images to upload"}function a(e){this.classList.remove("highlight"),t.innerText="Upload up to 10 images"}function n(e){e.preventDefault(),e.stopPropagation()}}addHandlerRemoveImage(e){this.imageList.addEventListener("click",(function(t){t.preventDefault();if(!t.target.closest(".preview__card--remove-btn"))return;t.stopImmediatePropagation();const r=t.target.closest(".preview__card").dataset.imgId;e(r)}),!0)}addHandlerPreviewClick(e){this.imageList.addEventListener("click",(function(t){t.preventDefault();const r=t.target.closest(".preview__card")?.dataset.imgId;r&&e(r)}))}addHandlerRouteCardClick(e){document.addEventListener("click",(function(t){t.target.closest(".preview__card--route")&&e()}))}addHandlerLocationPreviewClick(e){this.imageList.addEventListener("click",(function(t){t.preventDefault();t.target.closest(".preview__card--location")&&e()}))}addHandlerRemoveCurrentLocation(e){this.imageList.addEventListener("click",(function(t){if(!t.target.closest(".location__card--remove-btn"))return;t.stopImmediatePropagation(),e();document.querySelector("#user-location").checked=!1}))}addHandlerSubmit(e){this.uploadForm.addEventListener("submit",(async t=>{t.preventDefault();const r=new FormData(this.uploadForm).get("transport-mode");e(r)}))}addHandlerClear(e){this._clearBtn.addEventListener("click",(t=>{e()}))}addHandlerUserLocation(e){this._userLocationInput.addEventListener("change",(t=>e(t)))}addHandlerRoutePanelBack(e){document.addEventListener("click",(function(t){t.target.closest(".route-panel--back-btn")&&e()}))}addHandlerDragPreviewCard(e){this.imageList.addEventListener("dragstart",(function(e){const t=e.target.closest(".preview__card");t&&t.classList.add("dragging")})),this.imageList.addEventListener("dragend",(function(e){const t=e.target.closest(".preview__card");t&&t.classList.remove("dragging")})),this.imageList.addEventListener("dragover",(function(e){e.preventDefault();const t=document.querySelector(".dragging"),r=(a=this,n=e.clientY,[...a.querySelectorAll(".preview__card:not(.dragging)")].reduce(((e,t)=>{const r=t.getBoundingClientRect(),a=n-r.top-r.height/2;return a<0&&a>e.offset?{offset:a,element:t}:e}),{offset:Number.NEGATIVE_INFINITY}).element);var a,n;null==r?this.appendChild(t):this.insertBefore(t,r);[...this.querySelectorAll(".preview__card")].forEach(((e,t)=>{e.setAttribute("data-img-order",t)}))})),this.imageList.addEventListener("drop",(function(t){t.preventDefault(),e()}))}renderPreviewCard({file:e,file:{exifdata:t},latitude:r,longitude:a,imgId:n,imgOrder:o}){const i=document.createElement("div");i.classList.add("preview__card"),i.setAttribute("draggable","true"),i.setAttribute("title","Drag to reorder image"),i.dataset.imgOrder=o,i.dataset.imgId=n;const d=document.createElement("div");d.classList.add("preview__card--header");const s=document.createElement("div");s.classList.add("preview__card--text");const c=document.createElement("button");c.innerText="✕",c.setAttribute("title","Remove this item"),c.classList.add("preview__card--remove-btn");const l=document.createElement("img");if(l.classList.add("preview__image"),l.src=URL.createObjectURL(e),l.onload=()=>{URL.revokeObjectURL(l.src)},s.innerHTML=`\n      <dl>\n        <dt>lat, lng: </dt><dd>${r.toFixed(2)}, ${a.toFixed(2)}</dd>\n        <dt>Camera:</dd><dd> ${t.Make} ${t.Model}</dd>\n      </dl>\n    `,t.DateTime){const[e,r,a,n,o,i]=t.DateTime.split(/[: ]/),d=new Date(e,r-1,a,n,o,i);d&&s.insertAdjacentHTML("afterbegin",`<dl>\n            <dt>Date:</dt><dd>${d.toLocaleDateString()}</dd>\n            <dt>Time:</dt><dd>${d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</dd>\n          </dl>\n          `)}d.appendChild(l),i.appendChild(d),i.appendChild(c),i.appendChild(s),this.imageList.insertAdjacentElement("beforeend",i)}renderRoutePreviewCard(e,t){const o=a(e.paths[0].time),d=e.paths[0].distance;document.getElementsByClassName("preview__card--route").length||(this.routePreviewCard=document.createElement("div"),this.routePreviewCard.classList.add("preview__card--text","preview__card--route","preview__card"),this.imageList.insertAdjacentElement("beforebegin",this.routePreviewCard)),this.routePreviewCard.innerHTML=`\n    <h4>${i[t]} Route</h4>\n    <span><h4>${o}</h4>\n    <p>${n(r(d),100)} mi</p>\n    </span>\n    <h4>Details  ➡</h4>\n    `}renderRoutePanel(e,t){const o=i[t],d=a(e.paths[0].time),s=e.paths[0].distance;document.getElementsByClassName("route-panel").length||(this.routePanel=document.createElement("div"),this.routePanel.classList.add("route-panel","preview__card--text"));const c=document.createElement("header"),l=document.createElement("h2");l.innerHTML=`${o} Route`,c.appendChild(l);const u=e.paths[0].points.coordinates[0].map((e=>e.toFixed(3))).join(", "),m=e.paths[0].points.coordinates.pop().map((e=>e.toFixed(3))).join(", "),g=document.createElement("div");g.classList.add("route-panel__overview"),g.innerHTML=`\n    <p>From: <strong>${u}</strong></p>\n    <p>To: <strong>${m}</strong></p>\n    `,g.insertAdjacentHTML("beforeend",`<p class="route-length"><strong>${d}</strong> (${n(r(s),100)} miles)</p>`);const p=document.createElement("button");p.innerText="←",p.setAttribute("title","Back to image list"),p.classList.add("route-panel--back-btn","btn--small"),g.appendChild(p),c.appendChild(g),this.routePanel.appendChild(c);const h=document.createElement("dl");h.innerHTML=`${e.paths[0].instructions.map(((e,t)=>`\n        <dt>${t+1}</dt>\n        <dd>${e.text}</dd>\n        `)).join("")}`,this.routePanel.appendChild(h),this.imageList.replaceChildren(this.routePanel)}renderLocationCard(e){if(!e)return;document.getElementsByClassName("preview__card--location").length||(this.locationPreviewCard=document.createElement("div"),this.locationPreviewCard.classList.add("preview__card","preview__card--location","preview__card--text"),this.locationPreviewCard.setAttribute("draggable","true"),this.imageList.insertAdjacentElement("afterbegin",this.locationPreviewCard)),this.locationPreviewCard.innerHTML=`\n      <header><h4>Current Location: </h4>\n      <span><p>${e[0].toFixed(2)},${e[1].toFixed(2)}</p>\n      </span></header>\n    `,this.locationPreviewCard.dataset.imgId="currentCoords",this.locationPreviewCard.dataset.imgOrder=0;const t=document.createElement("button");t.innerText="x",t.setAttribute("title","Remove current location"),t.classList.add("location__card--remove-btn"),this.locationPreviewCard.appendChild(t)}renderAllImgs(e){e.sort(((e,t)=>e.imgOrder-t.imgOrder)).map((e=>e.currentPosition?this.renderLocationCard([e.latitude,e.longitude]):this.renderPreviewCard(e)))}renderToast(e,t="error"){const r=document.createElement("div");r.innerHTML=e,r.classList.add("toast",`toast--${t}`);const a=document.querySelectorAll(".toast");if(a){let e="6rem";for(let t=0;t<a.length;t++)r.style.bottom=`calc(${t+1} * ${e})`}document.body.appendChild(r),setTimeout((()=>r.classList.add("toast--show")),500),setTimeout((()=>r.classList.remove("toast--show")),5e3),setTimeout((()=>document.body.removeChild(r)),5500)}removeRouteInfo(){this.routePreviewCard&&this.routePreviewCard.remove(),this.routePanel&&this.routePanel.remove()}};const w=[-77.041493,38.930859];var C=new class{constructor(){this.map=L.map("map").setView([w[1],w[0]],5),this.tiles=L.tileLayer("https://api.mapbox.com/styles/v1/lanesgood/clhsi5wdt00yk01pffukxf1s4/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibGFuZXNnb29kIiwiYSI6ImNsaHNoeDJ4czJ4b3UzbHFrZHQ3cHNteGsifQ.Pcn60PP-gOgbEb2z9TOAMA",{minZoom:0,maxZoom:22}),this.routeLine=L.polyline([]),this.photoMarkers=L.layerGroup(),this.currentPositionMarker=L.marker()}render(){this.tiles.addTo(this.map),this.photoMarkers.addTo(this.map)}renderPhotoMarker(e,t,r,a){const n=URL.createObjectURL(r),o=L.popup({autoClose:!1}).setContent(`<img class='marker-photo' src='${n}' />`),i=L.marker([e,t]);i.imgId=a,this.photoMarkers.addLayer(i),i.bindPopup(o).openPopup()}flyToDefaultCoords(){this.map.flyTo([w[1],w[0]],10)}flyToImageBounds(e){this.map.flyToBounds(e.map((({latitude:e,longitude:t})=>[e,t])))}renderRouteLine(e,t){const r=e.paths[0].points.coordinates.map((e=>[e[1],e[0]])),n=a(e.paths[0].time);this.routeLine.setLatLngs(r).setStyle({weight:"4",color:d[t],dashArray:"10"}).addTo(this.map),this.routeLine.bindPopup(`${i[t]}: ${n}`).openPopup()}clearRouteLine(){this.routeLine.remove()}};const{state:y}=t,I=async function(e){let r=y.images.length;for(let a=0;a<e.length;a++){const n=e[a];if(y.images.some((e=>e.file?.name===n.name)))P.renderToast(`${n.name} is already in the destination list`,"info");else{const e=r++,a=crypto.randomUUID();try{const r=await t.getExifData(n),o=t.prepareImageData(r,n.name),{latitude:i,longitude:d}=o,s={file:n,imgId:a,imgOrder:e,latitude:i,longitude:d};t.addImage(s),C.renderPhotoMarker(i,d,n,a),P.renderPreviewCard(s),C.flyToImageBounds(y.images)}catch(e){P.renderToast(e),console.error(e)}}}C.clearRouteLine(),P.removeRouteInfo(),P.fileInput.value="",H(y.transportMode)},T=function(e){C.clearRouteLine(),P.removeRouteInfo();let r=e.target.value;t.setTransportMode(r),H(y.transportMode)},_=function(e){const t=y.images.find((t=>t.imgId===e));C.map.flyTo([t.latitude,t.longitude],15),C.photoMarkers.eachLayer((t=>{t.imgId===e&&t.openPopup()}))},E=function(){P.renderRoutePanel(y.routeData,y.transportMode)},k=function(){P.routePanel.remove(),P.renderAllImgs(y.images)},b=function(e){C.photoMarkers.eachLayer((t=>{t.imgId===e&&C.map.removeLayer(t)})),P.imageList.removeChild(P.imageList.querySelector(`[data-img-id="${e}"]`)),t.removeImage("imgId",e),C.clearRouteLine(),P.removeRouteInfo(),H(y.transportMode)},M=async function(e){if(e.target.checked)try{const{coords:{latitude:e,longitude:r}}=await t.getPosition();t.addImage({file:null,imgId:"currentCoords",imgOrder:1e3,latitude:e,longitude:r,currentPosition:!0}),C.currentPositionMarker.setLatLng([e,r]),C.currentPositionMarker.bindPopup("Current location"),C.photoMarkers.addLayer(C.currentPositionMarker),P.renderLocationCard([e,r]),C.currentPositionMarker.openPopup(),C.flyToImageBounds(y.images),H(y.transportMode)}catch(e){console.error(e),P.renderToast(e.message)}else if(!e.target.checked)return C.map.hasLayer(C.currentPositionMarker)&&C.map.removeLayer(C.currentPositionMarker),t.removeImage("currentPosition",!0),y.images.length>0?C.flyToImageBounds(y.images):C.flyToDefaultCoords(),P.imageList.removeChild(P.locationPreviewCard),C.photoMarkers.removeLayer(C.currentPositionMarker),P.removeRouteInfo(),C.clearRouteLine(),H(y.transportMode),y.images},R=function(){let e=y.images.find((e=>e.currentPosition));C.map.flyTo([e.latitude,e.longitude],15)},D=function(){t.removeImage("currentPosition",!0),P.imageList.removeChild(P.locationPreviewCard),P.removeRouteInfo(),C.clearRouteLine(),C.map.hasLayer(C.currentPositionMarker)&&C.map.removeLayer(C.currentPositionMarker),H(y.transportMode)},S=function(){const e=[...P.imageList.querySelectorAll(".preview__card")].map((e=>e.getAttribute("data-img-id")));t.sortImages(e),H(y.transportMode)},H=async function(e){if(!(y.images.length<2)){P.removeRouteInfo(),C.clearRouteLine(),t.setTransportMode(e);try{const e=await t.getRoute(y.transportMode);y.routeData=e,C.flyToImageBounds(y.images),C.renderRouteLine(y.routeData,y.transportMode),P.renderRoutePreviewCard(y.routeData,y.transportMode)}catch(e){P.renderToast(e)}}},$=function(){y.images.length=0,C.photoMarkers.clearLayers(),C.clearRouteLine(),C.flyToDefaultCoords(),P.imageList.replaceChildren(),P.removeRouteInfo(),P.form.reset()};window.addEventListener("DOMContentLoaded",(()=>{console.log("Snappy trails is up and running. Reticulating splines"),y.images.length>0&&P.renderAllImgs(y.images),C.render(),P.addHandlerUserLocation(M),P.addHandlerFileInput(I),P.addHandlerTransportButton(T),P.addHandlerDropInput(I),P.addHandlerPreviewClick(_),P.addHandlerDragPreviewCard(S),P.addHandlerLocationPreviewClick(R),P.addHandlerRemoveCurrentLocation(D),P.addHandlerRemoveImage(b),P.addHandlerSubmit(H),P.addHandlerRouteCardClick(E),P.addHandlerRoutePanelBack(k),P.addHandlerClear($)}));
//# sourceMappingURL=index.6a3b60aa.js.map
